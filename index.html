<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Third Space – Cellar Tools</title>
  <link rel="manifest" href="manifest.json">

  <style>
    :root {font-family: system-ui, sans-serif;}
    body   {margin:0;padding:1rem;background:#f8f8f8}
    .card  {background:#fff;padding:1rem;border-radius:8px;
            box-shadow:0 2px 6px #0002;max-width:430px}
    label  {display:block;margin:6px 0}
    label strong{display:inline-block;width:3.9rem}
    input  {width:6rem}
    button {margin-top:10px;padding:.5rem 1rem;border:1px solid #888;
            border-radius:6px;background:#e6e6e6}
    h2     {margin-top:0}
  </style>
</head>
<body>

<!-- ========================================================= -->
<!-- 3-TURN GRAVITY DILUTION CALCULATOR                         -->
<!-- ========================================================= -->
<section class="card">
  <h2>3-Turn Gravity Dilution</h2>

  <!-- Turn 1 -->
  <strong>Turn 1</strong>
  <label><strong>G</strong> (°P) <input id="g1" type="number" step="0.01"></label>
  <label><strong>V</strong> (bbl) <input id="v1" type="number" step="0.01"></label>

  <!-- Turn 2 -->
  <strong>Turn 2</strong>
  <label><strong>G</strong> (°P) <input id="g2" type="number" step="0.01"></label>
  <label><strong>V</strong> (bbl) <input id="v2" type="number" step="0.01"></label>

  <!-- Turn 3 (pre-dilution) -->
  <strong>Turn 3</strong>
  <label><strong>G</strong> (°P) <input id="g3" type="number" step="0.01"></label>
  <label><strong>V</strong> (bbl) <input id="v3" type="number" step="0.01"></label>

  <!-- Target -->
  <label style="margin-top:8px">
    <strong>Target&nbsp;G</strong> (°P)
    <input id="gt" type="number" step="0.01">
  </label>

  <button onclick="calcWater()">Calculate</button>

  <p id="waterOut"></p>
  <p id="residOut" style="font-size:.9rem;color:#555"></p>
</section>

<script>
/* -------------------------------------------------------------
   CALCULATE WATER ADDITION – handles 0, 1, 2 or 3 existing turns
   ------------------------------------------------------------- */
function calcWater(){
  // helper ⇒ blanks → 0
  const num = id => +document.getElementById(id).value || 0;

  // gather inputs
  const g1 = num('g1'), v1 = num('v1'),
        g2 = num('g2'), v2 = num('v2'),
        g3 = num('g3'), v3 = num('v3'),
        gt = num('gt');

  /* -------- validation -------- */
  if (!gt || gt <= 0 || Math.abs(gt - 1) < 1e-6){
    alert("Enter a target gravity (>0 °P and ≠ 1 °P).");
    return;
  }

  const extract = g1*v1 + g2*v2 + g3*v3;  // total °P·bbl
  const vol     = v1 + v2 + v3;           // total bbl

  if (vol === 0){
    alert("Enter at least one turn with non-zero volume.");
    return;
  }

  /* -------- closed-form water calc --------
       W = (G_t · V  −  Σ G_i·V_i)  /  (1 − G_t)
     ---------------------------------------- */
  const w = (gt*vol - extract) / (1 - gt);   // bbl water @ 1 °P

  if (w < 0){
    alert("Target gravity is higher than current blend (water volume would be negative).");
    return;
  }

  const finalG = (extract + w) / (vol + w);
  const resid  = finalG - gt;

  waterOut.textContent =
      `Add <b>${w.toFixed(2)} bbl</b> of 1 °P water ⇒ final gravity ≈ ${finalG.toFixed(3)} °P`;
  residOut.textContent =
      `Residual ${resid.toExponential(2)} (should be 0)`;
}

/* optional offline caching */
if ('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
